{% extends 'panel.html' %}

{% block content%}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<style>
    .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    .form-help {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 3px;
    }

    .card-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 100vh;  
        margin-top: 50px; 
    }

    .card-custom {
        width: 900px;  
        padding: 20px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); 
        border-radius: 10px; 
        
    }

    @keyframes fadeOut {
        0% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; display: none; }
    }

    .alert {
        animation: fadeOut 6s ease-in-out forwards;
    }

    .btn-pill {
        padding: 10px 20px;
        width: 400px; /* Ancho fijo */
        align-items: center;
        
    }

</style>

<div class="container mt-5">
    <h3>Definir Targeting para Cluster <strong>{{ cluster }}</strong> del modelo <strong>{{ modelo.nombre }}</strong></h3>
    
    <div class="d-flex justify-content-between" style="text-align: right;">
        <button type="button" class="btn-pill" onclick="generarTargetingIA()">✨Generar Targeting Automático con IA</button>
    </div>

    <form method="post" style="margin-top: 1em;" id="formulario-vacante">

        <div class="card-container">

            <div class="card card-custom">
                {% csrf_token %}

                <div id="alerta-exito" class="alert alert-success mt-3 d-none" role="alert">
                    Targeting generado exitosamente.
                </div>

                <div class="mb-2">
                    <label class="form-label">Ubicación (meta):</label>
                    <input type="text" class="form-control" name="meta_location" id="id_meta_location">
                </div>

                <div class="mb-2">
                    <label class="form-label">Nivel educativo: </label>
                    <input type="text" class="form-control" name="education_level" id="id_education_level">
                </div>

                <div class="mb-2">
                    <label class="form-label">Edad mínima: </label>
                    <input type="number" class="form-control" name="age_min" id="id_age_min">
                </div>

                <div class="mb-2">
                    <label class="form-label">Edad máxima: </label>
                    <input type="number" class="form-control" name="age_max" id="id_age_max">
                </div>

                <div class="mb-2">
                    <label class="form-label">Intereses</label><br>
                    {% for interest in interests %}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="interests" value="{{ interest }}" id="interest_{{ forloop.counter }}">
                            <label class="form-check-label" for="interest_{{ forloop.counter }}">{{ interest }}</label>
                        </div>
                    {% endfor %}
                </div>

                <button type="submit" class="btn-pill">Guardar Targeting</button>

                <div style="height: 50px;"></div> 

            </div>
            
        </div>

    </form>

</div>


<script>
    function generarTargetingIA() {
        fetch("{% url 'generar_targeting_ia' modelo.pk cluster %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                const alerta = document.getElementById("alerta-exito");
                alerta.classList.remove("d-none");

                // Llenar campos simples
                document.getElementById("id_meta_location").value = data.meta_location;
                document.getElementById("id_education_level").value = data.education_level;
                document.getElementById("id_age_min").value = data.age_min;
                document.getElementById("id_age_max").value = data.age_max;

                // Llenar intereses si es MultipleChoiceField
                const interestsSelect = document.getElementById("id_interests");
                if (interestsSelect && interestsSelect.options) {
                    for (let i = 0; i < interestsSelect.options.length; i++) {
                        const option = interestsSelect.options[i];
                        option.selected = data.interests.includes(option.value);
                    }
                }
            } else {
                alert("Error al generar targeting con IA: " + data.error);
            }
        })
        .catch(error => {
            alert("Ocurrió un error inesperado: " + error);
        });
    }
</script>

{% endblock %}
